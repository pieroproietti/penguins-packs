#!/bin/bash

# =================================================================================
# AVVISO: Questo script cancellerà completamente tutti i dati su /dev/sda.
# Eseguilo con estrema cautela e solo dopo aver verificato il nome del disco.
# Deve essere eseguito con privilegi di root (ad esempio, usando sudo).
# =================================================================================

set -e # Esce immediatamente se un comando fallisce.
set -u # Tratta le variabili non impostate come un errore.

# --- CONFIGURAZIONE ---
# Assicurati che questo sia il disco corretto!
DISK="/dev/sda"
# --------------------

echo "### ATTENZIONE: Tutti i dati su ${DISK} saranno distrutti permanentemente. ###"
echo "Questo script configurerà il disco con una tabella MBR per un sistema BIOS."
read -p "Sei assolutamente sicuro di voler continuare? (scrivi 'yes'): " CONFIRMATION

if [ "$CONFIRMATION" != "yes" ]; then
    echo "Operazione annullata."
    exit 1
fi

echo "--- Avvio del processo su ${DISK} ---"

# 1. Cancellazione di tutte le partizioni e firme esistenti
#    Questo assicura che il disco sia completamente pulito prima di iniziare.
echo "Passo 1: Pulizia completa del disco ${DISK}..."
wipefs -a ${DISK}
#dd if=/dev/zero of=${DISK} bs=1M count=10 status=progress

# 2. Creazione di una nuova tabella delle partizioni MBR (msdos)
#    Questa è la tabella corretta per un sistema BIOS tradizionale.
echo "Passo 2: Creazione di una nuova tabella delle partizioni MBR (msdos)..."
parted -s ${DISK} mklabel msdos

# 3. Creazione della partizione principale
#    Si inizia a 1MiB per lasciare lo spazio necessario per il bootloader GRUB
#    nello spazio tra l'MBR e l'inizio della prima partizione.
echo "Passo 3: Creazione di una partizione primaria che lascia spazio per GRUB..."
parted -s -a optimal ${DISK} mkpart primary ext4 1MiB 100%

# Informa il kernel delle avvenute modifiche alla tabella delle partizioni
partprobe ${DISK}
sleep 2 # Dà al sistema un momento per recepire le modifiche

# 4. Formattazione della nuova partizione (es. /dev/sda1) in ext4
echo "Passo 4: Formattazione della nuova partizione (${DISK}1) in ext4..."
mkfs.ext4 -F "${DISK}1"

echo "--- ✅ Processo completato con successo! ---"
echo "${DISK} è stato partizionato e formattato per un sistema BIOS con GRUB."